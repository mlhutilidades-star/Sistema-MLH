// ==========================================
// SISTEMA MLH - SCHEMA PRISMA COMPLETO
// PostgreSQL Database Schema
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// BASE_PRODUTOS - Catálogo de produtos
// ==========================================
model Produto {
  id            String   @id @default(cuid())
  sku           String   @unique
  descricao     String
  ncm           String?
  custoReal     Float    // Campo mestre de custo (Tiny)
  custoStatus   String   @default("OK") // OK | PENDENTE_SYNC
  custoAtualizadoEm DateTime?
  precoVenda    Float?
  idTiny        String?  @unique
  estoqueTiny   Int?
  idShopee      String?
  estoqueShopee Int?
  ativo         Boolean  @default(true)
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt

  @@map("produtos")
  @@index([sku])
  @@index([idTiny])
}

// ==========================================
// PEDIDOS - Rentabilidade real por venda
// Renda = escrow_amount (Shopee)
// Custo = soma de Produto.custoReal * qty
// ==========================================
model Pedido {
  id           String   @id @default(cuid())
  pedidoId     String   @unique // order_sn Shopee
  data         DateTime
  cliente      String?
  totalBruto   Float    @default(0)
  taxasShopee  Float    @default(0)
  rendaLiquida Float    @default(0)
  custoProdutos Float   @default(0)
  lucro        Float    @default(0)
  margem       Float    @default(0) // (lucro / rendaLiquida) * 100
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  itens PedidoItem[]

  @@map("pedidos")
  @@index([data])
}

model PedidoItem {
  id            String   @id @default(cuid())
  pedidoId      String
  sku           String
  descricao     String?
  quantidade    Int      @default(1)
  precoVenda    Float?   // preço do item (quando disponível)
  rendaLiquida  Float    @default(0) // renda alocada do pedido para o item
  custoUnitario Float    @default(0)
  custoTotal    Float    @default(0)
  lucro         Float    @default(0)

  pedido Pedido @relation(fields: [pedidoId], references: [pedidoId], onDelete: Cascade)

  @@map("pedido_itens")
  @@unique([pedidoId, sku])
  @@index([sku])
}

// ==========================================
// ANUNCIOS - visão simples (por dia/campanha)
// Obs: sem atribuição direta, serve como agregação de gasto.
// ==========================================
model Anuncio {
  id            String   @id @default(cuid())
  data          DateTime @db.Date
  campanhaId    String
  campanhaNome  String?
  gasto         Float    @default(0)
  rendaGerada   Float    @default(0)
  custoProdutos Float    @default(0)
  lucro         Float    @default(0)
  roi           Float    @default(0)
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt

  @@map("anuncios")
  @@unique([data, campanhaId])
  @@index([data])
}

// ==========================================
// FINANCEIRO - Contas a Pagar
// ==========================================
model ContaPagar {
  id            String   @id @default(cuid())
  vencimento    DateTime
  descricao     String
  fornecedor    String
  categoria     String
  valor         Float
  status        String   @default("PENDENTE") // PENDENTE, PAGO, VENCIDO
  linkPdf       String?
  dataPagamento DateTime?
  idTiny        String?  @unique
  observacoes   String?
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt

  @@map("contas_pagar")
  @@index([vencimento])
  @@index([status])
}

// ==========================================
// FINANCEIRO - Contas a Receber
// ==========================================
model ContaReceber {
  id            String   @id @default(cuid())
  previsao      DateTime
  cliente       String
  categoria     String
  pedidoId      String?
  valorBruto    Float
  taxas         Float    @default(0)
  custoAds      Float    @default(0) // Rateado por receita
  liquido       Float    // valorBruto - taxas - custoAds
  status        String   @default("PENDENTE") // PENDENTE, RECEBIDO
  dataRecebimento DateTime?
  idTiny        String?  @unique
  idShopee      String?
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt

  @@map("contas_receber")
  @@index([previsao])
  @@index([status])
}

// ==========================================
// CONCILIAÇÃO - Extrato Bancário
// ==========================================
model ExtratoBanco {
  id            String   @id @default(cuid())
  data          DateTime
  descricao     String
  valor         Float
  saldo         Float
  categoria     String?  // Preenchido por regras
  conciliado    Boolean  @default(false)
  contaPagarId  String?
  contaReceberId String?
  observacoes   String?
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt

  @@map("extrato_banco")
  @@index([data])
  @@index([conciliado])
}

// ==========================================
// CONCILIAÇÃO - Regras de Categorização
// ==========================================
model RegraConciliacao {
  id            String   @id @default(cuid())
  padrao        String   // Regex ou palavra-chave
  categoria     String
  tipo          String   // RECEITA, DESPESA
  prioridade    Int      @default(1)
  ativo         Boolean  @default(true)
  descricao     String?
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt

  @@map("regras_conciliacao")
  @@index([ativo])
  @@index([prioridade])
}

// ==========================================
// M10_CONSUMO_ADS - Shopee Ads Performance
// ==========================================
model ConsumoAds {
  id            String   @id @default(cuid())
  data          DateTime @db.Date
  campanhaId    String
  campanhaNome  String?
  impressoes    Int
  cliques       Int
  gasto         Float
  pedidos       Int
  gmv           Float    // Gross Merchandise Value
  roas          Float?   // Return on Ad Spend (GMV / Gasto)
  ctr           Float?   // Click-Through Rate
  cpc           Float?   // Cost per Click
  criadoEm      DateTime @default(now())

  @@map("consumo_ads")
  @@unique([data, campanhaId])
  @@index([data])
}

// ==========================================
// LOGS DE SINCRONIZAÇÃO
// ==========================================
model LogSync {
  id            String   @id @default(cuid())
  tipo          String   // PRODUTOS, FINANCEIRO, ADS, PEDIDOS
  status        String   // SUCESSO, ERRO, PARCIAL
  origem        String   // TINY, SHOPEE
  mensagem      String?
  detalhes      String?  @db.Text
  registros     Int      @default(0)
  duracaoMs     Int?
  criadoEm      DateTime @default(now())

  @@map("logs_sync")
  @@index([tipo])
  @@index([criadoEm])
}

// ==========================================
// MAPEAMENTO SKU - Shopee -> Tiny
// Útil quando o SKU da Shopee não é o código cadastrado no Tiny.
// ==========================================
model MapeamentoSKU {
  id         String   @id @default(cuid())
  skuShopee  String   @unique
  codigoTiny String
  criadoEm   DateTime @default(now())

  @@map("mapeamento_sku")
  @@index([skuShopee])
}
